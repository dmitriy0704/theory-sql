# СТРУКТУРА ОПЕРАТОРА SELECT И ФОРМИРОВАНИЕ УСЛОВИЙ ВЫБОРА

Операторы SQL разделены на три группы:

1. Операторы манипулирования данными (Data Manipulation Language,
   DML) — предназначены для выборки и изменения данных: SELECT,
   INSERT, UPDATE, MERGE, DELETE.
2. Операторы определения данных (Data Definition Language, DDL) —
   предназначены для создания и модификации объектов базы данных. Основными
   операторами этой группы являются: CREATE, ALTER, DROP.
3. Операторы управления данными (Data Control Language, DCL) —
   предназначены для предоставления пользователям прав на выполнение
   определенных действий с базой данных: GRANT, REVOKE.

## СТРУКТУРА ОПЕРАТОРА SELECT

    SELECT [ALL(DISTINCT] {список столбцов или выражений}
    [FROM {список таблиц}]
    [WHERE {условия выбора}]
    [GROUP BY {столбцы группировки}]
    [HAVING {условия на группу}];
    [ORDER BY {столбцы сортировки [ASC|DESC]]}
    [LIMIT {N} ] [OFFSET{М}];

(Квадратными скобками отмечены необязательные элементы).

Описание элементов:

- Оператор SELECT начинается со списка столбцов или выражений, значения
  которых будет отображаться в результате выполнения запроса. По умолчанию
  SELECT не исключает дублирование строк. Для исключения дублирования следует
  использовать ключевое слово DISTINCT.
- В предложении FROM указываются источники данных. В качестве таких
  источников можно использовать таблицы базы данных, которые возвращают
  подзапросы или представления. В тех запросах, где используется несколько
  таблиц, необходимо указывать условия соединения. Если этого не сделать, то
  будет осуществляться декартово произведение таблиц.
- Предложение WHERE содержит условия выбора строк, а также может содержать
  условия соединения таблиц в многотабличных запросах.
- В предложении GROUP BY можно указать столбцы, по которым следует осуществить
  группировку. Группировка состоит в том, что несколько строк, имеющих
  совпадающие значения столбцов, по которым осуществляется группировка,
  объединяются в одну строку. Обычно группировка используется в запросах,
  использующих агрегатные функции, например:Sum(), Мах().

## Условия выбора (WHERE)

Для того чтобы выводить только те данные, которые
удовлетворяют определенным условиям, оператор SELECT
должен содержать предложение WHERE, которое содержит
условное выражение:

```
SELECT {список столбцов}
FROM {таблица}
WHERE {условное выражение};
```

Условное выражение для каждой строки таблицы может принимать значения:
ИСТИНА (TRUE), ЛОЖЬ (FALSE), НЕ ОПРЕДЕЛЕНО (UNKNOWN).
Результат выполнения запроса будет содержать только те
строки, для которых условное выражение будет иметь значение ИСТИНА (TRUE).

В условных выражениях предложения WHERE могут быть использованы
операторы сравнения =, >, < и логические операторы NOT, AND, OR. Логические
операторы используются для формирования сложных условий выбора
и имеют разный приоритет. Сначала выполняются все операторы NOT,
потом операторы AND; операторы OR выполняются в последнюю очередь.
Для исключения возможных ошибок при формировании сложных запросов
следует использовать скобки. Выражения внутри скобок выполняются первыми,
слева направо.

```
SELECT employee_id, first_name, last_name, department_id, job_id
FROM Employees
WHERE (department_id = 50) AND (job_id= 'ST_MAN');

SELECT * FROM Orders
WHERE (salesman_id = 155) AND (order_date ='15.03.2018'
OR order_date ='02.11.2019');
```

## Выражения выбора

Для формирования условий выбора можно использовать специальные выражения:

- `LIKE 'шаблон'`: Совпадает ли часть строкового значения с заданным шаблоном:
  [first_name LIKE '_а%'];
- `BETWEEN V_MIN AND V_MAX`:  
  Находится ли значение столбца в диапазоне от V_MIN до V_МАХ:
  [rating_e BETWEEN 2 And 4]:
- `IN(список)`: Совпадает ли значение столбца с одним из элементов списка
  значений: [rating_e IN (2;4)];
- `IS NULL`: Значение столбца не определено: [rating_e IS NULL];

### Выражение LIKE

Выражение LIKE применяется при работе со строками. Оно проверяет, совпадет ли
часть строки с заданным шаблоном. Если совпадение найдено, то оператор
возвращает значение TRUE, в противном случае возвращается FALSE.

Для создания шаблонов в выражении LIKE используются следующие
символы:

- символ подчеркивания "_" — обозначает один символ;
- символ процента "%" — обозначает любую, в том числе и пустую,
  последовательность символов.

Синтаксис:

```
{имя столбца} LIKE 'шаблон'
```

Примеры использования выражения LIKE:

- Вывод данных о сотрудниках, имена которых начинаются на букву L:

```
 SELECT employee_id, first_name, last_name, department_id
 FROM Employees
 WHERE first_name LIKE ' L% ';
```

- Вывести имена сотрудников, вторым символом которых является буква "а":

```
SELECT DISTINCT first_name
FROM Employees
WHERE first_name LIKE '_a%’;
```

Вывести имена сотрудников, которые состоят из четырех символов, начинаются на
букву J и заканчиваются буквой п:

```
SELECT DISTINCT first_name
FROM Employees
WHERE first_name LIKE 'J__n';
```

Для поиска в строке символов_ и % при построении шаблона используется
опция ESCAPE 7'. Символ, который в шаблоне будет располагаться после /,
будет рассматриваться как символ поиска. Вместо символа / можно использовать
и другие символы, например !.

Вывести имена и адреса клиентов, столбец address которых содержит символ "_":

```
SELECT c_name, address,
FROM Customers
WHERE address LIKE '%/_%' ESCAPE '/'
```

### Выражение BETWEEN

_Выражение BETWEEN используется для того, чтобы
результат запроса содержал только те строки, в которых
значение проверяемого столбца находится в заданном
диапазоне, включая его границы._

**Синтаксис:**

{имя столбца} BETWEEN V_MIN AND V_MAX

- V MIN — нижняя граница диапазона;
- V_MAX — верхняя граница диапазона.

Выражение BETWEEN эквивалентно двум операциям сравнения, объединенным логическим
оператором AND.

    ({имя столбца} >= V_MIN) AND ({имя столбца} >= Ѵ_МАХ)

### Выражение IN

Выражение Ш используется для того, чтобы результат
запроса содержал только те строки, в которых значение
проверяемого столбца совпадает с одним из значений,
указанных в списке.

Синтаксис:

    {имя столбца} IN {список значений}

Пример:

Вывести данные о сотрудниках, которые работают в отделах с определенными
номерами:

```
SELECT employee_id, first_name, last_name, department_id
FROM Employees
WHERE department_id IN (40, 10, 110);
```

### Выражение IS NULL

Выражение IS NULL используется для определения строк с
неопределенным значением заданного столбца.

    {имя столбца} IS NULL

Это выражение возвращает значение TRUE, если значение проверяемого
столбца будет NULL.

## Вычисляемые столбцы

В предложении SELECT, кроме списка столбцов таблиц, участвующих в запросе, могут
присутствовать вычисляемые столбцы, которые представляют собой выражения,
состоящие из имен столбцов, констант, функций и арифметических операций.
Значению вычисляемого столбца можно присвоить имя. Для этого используется
следующая конструкция

```
{Выражение} As {псевдоним}
```

___**Пример:**___

```
SELECT product_id, order_id, item_id, quantity, unit_price,
quantity*unit_price
FROM Order_iterns
WHERE quantity*unit__price > 400000;
```

## Операция конкатенации

Операция конкатенации (слияния) используется для того, чтобы объединить при
выводе данных два или несколько столбцов или литералов в один столбец. Операцию
конкатенации можно применять для строк, чисел и дат. Даты и числа при слиянии
конвертируются в строковые значения.

___**Синтаксис:**___

```
{столбеці/литерал 1} || {столбец2 / литерал2}... Аз {псевдоним}
```

___**Пример:**___

```
select
'Order ' || orders.order_id || '  from ' || orders.order_date || ' is ' ||
orders.status AS Order_Status
FROM Orders
WHERE salesman_id = 165;
```

Для выполнения слияния можно использовать функцию
СОМСАТ, которая имеет следующий синтаксис:

```
CONCAT({столбеці/литерал 1}, {столбец2/литерал2},...)
```

___**Пример:**___

```
SELECT CONCAT('Order ',order_id,' from ',order_date,' is ',status)
AS Order_Statys
FROM Orders
WHERE salesman_id =165;
```

## Условные выражения

Довольно часто значение столбца, которое должен вернуть SQL-запрос, зависит от
условий, которые нужно проверять для каждой строки. Для реализации подобного
выбора используются выражение CASE. Используя это выражение, можно реализовать
условную логику if-then-else в операторе SELECT. Можно использовать два варианта
выражения CASE:

1. Выражение CASE с параметром;
2. Выражение CASE с условием.

### Выражение CASE с параметром

___**Синтаксис:**___

```
CASE {параметр}
    WHEN {значениеі} THEN {результаті}
    [WHEN {значение2} THEN {результат2}
    WHEN {значениеИ} THEN {результат^ ]
    [ELSE {результат_ЕЬ8Е}]
END
```

Выражение CASE выполняется следующим образом:

- Сравнивается значение {параметр} со значениями {значение і} в предложениях
  WHEN, и возвращается результат {результат!} первого предложения, в котором
  будет выполнено условие {параметр} = {значение!}.
- Если ни в одном из предложений WHEN не выполняется условие {параметр} =
  {значение!}, то возвращается значение {результат_ELSE}. Если предложение ELSE
  отсутствует, то выражение CASE вернет результат NULL.
- Возвращаемый результат может быть значением или выражением. Выражения
  {параметр} и {значение} должны иметь один и тот же тип данных. Все
  возвращаемые значения должны иметь одинаковый тип данных.

___**Пример:**___

Вывести данные о сотрудниках и размере
их премии, которая задана в виде фиксированной суммы,
размер которой зависит от отдела, где работает сотрудник

```
SELECT department_id, employee_id, first_name, last_name, job_id,
salary,
    CASE department_id
        WHEN 10 THEN 1000
        WHEN 30 THEN 1200
        WHEN 40 THEN 1500
        ELSE 500
    END AS bonus
FROM Employees
WHERE department_id IN (10,20,30,40)
ORDER BY department_id;
```
