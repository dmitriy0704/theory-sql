# PostgreSQL

> Изучение материала на практичеких примерах

## Создание пользователей и предоставление им прав

### Создание роли

При установке PostgreSQL автоматически создается роль postgres, которая
имеет все возможные атрибуты и привилегии. Пользователь, который обладает ролью
postgres, является администратором базы данных и должен создавать другие роли и
предоставлять им привилегии.

```shell
CREATE ROLE {имя роли} {список атрибутов}
 ```

Описание некоторых часто используемых атрибутов:

- SUPERUSER — определяет, будет ли эта роль суперпользователем,
  который может переопределить все ограничения доступа в базе данных. Создать
  нового суперпользователя может только суперпользователь. В отсутствие этих
  предложений по умолчанию подразумевается NOSUPERUSER.
- CREATEDB — определяет то, что эта роль сможет создавать базы данных. По
  умолчанию подразумевается NOCREATEDB.
- CREATEROLE — определяет, сможет ли роль создавать новые роли, по
  умолчанию подразумевается NOCREATEROLE.
- INHERIT — определяет, будет ли роль «наследовать» права ролей, членом которых
  она является. По умолчанию подразумевается INHERIT.
- LOGIN — определяет, разрешается ли роли вход на сервер, то есть может ли эта
  роль стать начальным авторизованным именем при подключении клиента. По
  умолчанию подразумевается вариант NOLOGIN.
- BYPASSRLS — определяет, будут ли для роли игнорироваться все политики защиты
  на уровне строк (RLS). Создавать роли с атрибутом
  BYPASSRLS разрешено только суперпользователям, по умолчанию подразумевается
  вариант NOBYPASSRLS.
- CONNECTION LIMIT — определяет предел подключений. Если роли разрешён вход,
  этот параметр определяет, сколько параллельных подключений может установить
  роль. Значение -1 (по умолчанию) снимает ограничение.
- PASSWORD 'пароль' — задаёт пароль роли. Если проверка подлинности по паролю не
  будет использоваться, этот параметр можно опустить.

### Предоставление привилегий

Роли определяются для всей базы данных, но для того, чтобы пользователь,
обладающий определенной ролью, мог осуществлять операции с ее объектами ему
должны быть предоставлены соответствующие привилегии. Примечание: если роль
имеет атрибут SUPERUSER, то все привилегии предоставляются автоматически.
Привилегии предоставляются для различных видов объектов базы данных.

Для работы с различными объектами базы данных могут быть предоставле­
ны следующие привилегии:

- SELECT — позволяет оператору SELECT извлекать данные из столбцов
  таблицы или представления.
- INSERT — позволяет добавлять новые строки в таблицу, может быть
  предоставлена для определенных столбцов таблицы.
- DELETE — разрешает удалять строки из таблицы.
- TRUNCATE — разрешает осуществлять очистку таблицы.
- REFERENCES — позволяет создавать ограничение внешнего ключа для
  таблицы.
- TRIGGER — позволяет создавать триггер для таблицы или представления.
- CREATE — для баз данных позволяет создавать новые схемы, а для схем
  позволяет создавать новые объекты внутри схемы.
- CONNECT — позволяет подключаться к базе данных.
- TEMPORARY — позволяет создавать временные таблицы при использовании базы
  данных.
- EXECUTE — позволяет вызывать функцию или процедуру. Это единственный тип
  привилегий, который применим к функциям и процедурам.
- USAGE — для процедурных языков позволяет использовать язык для
  создания функций на этом языке. Это единственный тип привилегий, который
  применим к процедурным языкам. Для схем разрешает доступ к объектам,
  содержащимся в схеме. Для последовательностей разрешает использование функций
  currval и nextval. Для типов и доменов разрешает использование типа или
  домена при создании таблиц, функций и других объектов схемы.
- ALL \[PRIVILEGES] — предоставляет все привилегии, которые могут
  быть предоставлены для определенного типа объекта. Ключевое слово
  PRIVILEGES является необязательным в PostgreSQL, хотя в стандарте
  SQL оно требуется.

В таблице 1.1 приведены рассмотренные привилегии и указаны типы
объектов, которым они могут быть предоставлены.

| Привилегия | Применимые типы объектов                          |
|------------|---------------------------------------------------|
| SELECT     | Таблица, столбец таблицы, последовательность      |
| INSERT     | Таблица, столбец таблицы                          |
| UPDATE     | Таблица, столбец таблицы, последовательность      |
| DELETE     | Таблица                                           |
| TRUNCATE   | Таблица                                           |
| REFERENCES | Таблица, столбец таблицы                          |
| TRIGGER    | Таблица                                           |
| CREATE     | База данных, схема                                |
| CONNECT    | База данных                                       |
| TEMPORARY  | База данных                                       |
| EXECUTE    | Хранимые процедуры и функции                      |
| USAGE      | Процедурные языки, схема, последовательность, тип |

Выдать привилегии можно с помощью команды GRANT, которая имеет следующий формат:

```shell
GRANT {привилегии} ON {объект} ТО {роль};

# Предоставление привилегий SELECT, UPDATE, INSERT для всех 
# таблиц в схеме HR_POC роли folomkin_dev
grant select, update, insert on all tables in schema hr_poc to folomkin_dev;

#Предоставление всех привилегий для всех таблиц в схеме HR POC
#роли folomkin_dev
grant all privileges on all tables in schema hr_poc to folomkin_dev;

#Предоставление всех привилегий для таблицы customers в 
#схеме hr_poc роли folomkin_dev.
GRANT ALL PRIVILEGES ON TABLE customers IN SCHEMA HR_POC TO folomkin_dev;

#Предоставление привилегий на создание и просмотр объектов в схеме
#hr_poc роли folomkin_dev.
GRANT create, usage ON SCHEMA HR_POC TO folomkin_dev;
```

Данные о предоставленных привилегиях содержатся в таблице
information_schema.role_table_grants.

### Отзыв привилегий

Для отзыва предоставленных привилегий используется команду

```shell
REVOKE {привилегии} ON {объект} FROM {роль};

#Отзыв привилегий INSERT для всех таблиц в схеме HR_POC у роли user1.
REVOKE INSERT ON ALL TABLES IN SCHEMA HR_POC FROM user1;

#Отзыв привилегий DELETE, TRUNCATE для одной таблицы у роли user1.
REVOKE DELETE, TRUNCATE ON TABLE customers FROM user1;

#Отзыв привилегий UPDATE для столбца creditlimit таблицы customers у роли user1.
REVOKE UPDATE (credit_limit) ON TABLE customers FROM user1;
```

### Пример создания новой базы данных и предоставления привилегий

```shell
create database test;
create role developer superuser createdb login password 'developer';
grant all privileges on database test to developer;
create schema hr_poc3;
create table customers
(
    customer_id integer primary key ,
    c_name varchar(255) not null ,
    address varchar(255),
    credit_limit numeric(10,2)
);
```

## Редактор SQL


