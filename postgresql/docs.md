# PostgreSQL

> Изучение материала на практичеких примерах

## Создание пользователей и предоставление им прав

### Создание роли

При установке PostgreSQL автоматически создается роль postgres, которая
имеет все возможные атрибуты и привилегии. Пользователь, который обладает ролью
postgres, является администратором базы данных и должен создавать другие роли и
предоставлять им привилегии.

```shell
CREATE ROLE {имя роли} {список атрибутов}
 ```

Описание некоторых часто используемых атрибутов:

- SUPERUSER — определяет, будет ли эта роль суперпользователем,
  который может переопределить все ограничения доступа в базе данных. Создать
  нового суперпользователя может только суперпользователь. В отсутствие этих
  предложений по умолчанию подразумевается NOSUPERUSER.
- CREATEDB — определяет то, что эта роль сможет создавать базы данных. По
  умолчанию подразумевается NOCREATEDB.
- CREATEROLE — определяет, сможет ли роль создавать новые роли, по
  умолчанию подразумевается NOCREATEROLE.
- INHERIT — определяет, будет ли роль «наследовать» права ролей, членом которых
  она является. По умолчанию подразумевается INHERIT.
- LOGIN — определяет, разрешается ли роли вход на сервер, то есть может ли эта
  роль стать начальным авторизованным именем при подключении клиента. По
  умолчанию подразумевается вариант NOLOGIN.
- BYPASSRLS — определяет, будут ли для роли игнорироваться все политики защиты
  на уровне строк (RLS). Создавать роли с атрибутом
  BYPASSRLS разрешено только суперпользователям, по умолчанию подразумевается
  вариант NOBYPASSRLS.
- CONNECTION LIMIT — определяет предел подключений. Если роли разрешён вход,
  этот параметр определяет, сколько параллельных подключений может установить
  роль. Значение -1 (по умолчанию) снимает ограничение.
- PASSWORD 'пароль' — задаёт пароль роли. Если проверка подлинности по паролю не
  будет использоваться, этот параметр можно опустить.

### Предоставление привилегий

Роли определяются для всей базы данных, но для того, чтобы пользователь,
обладающий определенной ролью, мог осуществлять операции с ее объектами ему
должны быть предоставлены соответствующие привилегии. Примечание: если роль
имеет атрибут SUPERUSER, то все привилегии предоставляются автоматически.
Привилегии предоставляются для различных видов объектов базы данных.

Для работы с различными объектами базы данных могут быть предоставле­
ны следующие привилегии:

- SELECT — позволяет оператору SELECT извлекать данные из столбцов
  таблицы или представления.
- INSERT — позволяет добавлять новые строки в таблицу, может быть
  предоставлена для определенных столбцов таблицы.
- DELETE — разрешает удалять строки из таблицы.
- TRUNCATE — разрешает осуществлять очистку таблицы.
- REFERENCES — позволяет создавать ограничение внешнего ключа для
  таблицы.
- TRIGGER — позволяет создавать триггер для таблицы или представления.
- CREATE — для баз данных позволяет создавать новые схемы, а для схем
  позволяет создавать новые объекты внутри схемы.
- CONNECT — позволяет подключаться к базе данных.
- TEMPORARY — позволяет создавать временные таблицы при использовании базы
  данных.
- EXECUTE — позволяет вызывать функцию или процедуру. Это единственный тип
  привилегий, который применим к функциям и процедурам.
- USAGE — для процедурных языков позволяет использовать язык для
  создания функций на этом языке. Это единственный тип привилегий, который
  применим к процедурным языкам. Для схем разрешает доступ к объектам,
  содержащимся в схеме. Для последовательностей разрешает использование функций
  currval и nextval. Для типов и доменов разрешает использование типа или
  домена при создании таблиц, функций и других объектов схемы.
- ALL \[PRIVILEGES] — предоставляет все привилегии, которые могут
  быть предоставлены для определенного типа объекта. Ключевое слово
  PRIVILEGES является необязательным в PostgreSQL, хотя в стандарте
  SQL оно требуется.

В таблице 1.1 приведены рассмотренные привилегии и указаны типы
объектов, которым они могут быть предоставлены.

| Привилегия | Применимые типы объектов                          |
|------------|---------------------------------------------------|
| SELECT     | Таблица, столбец таблицы, последовательность      |
| INSERT     | Таблица, столбец таблицы                          |
| UPDATE     | Таблица, столбец таблицы, последовательность      |
| DELETE     | Таблица                                           |
| TRUNCATE   | Таблица                                           |
| REFERENCES | Таблица, столбец таблицы                          |
| TRIGGER    | Таблица                                           |
| CREATE     | База данных, схема                                |
| CONNECT    | База данных                                       |
| TEMPORARY  | База данных                                       |
| EXECUTE    | Хранимые процедуры и функции                      |
| USAGE      | Процедурные языки, схема, последовательность, тип |

Выдать привилегии можно с помощью команды GRANT, которая имеет следующий формат:

```shell
GRANT {привилегии} ON {объект} ТО {роль};

# Предоставление привилегий SELECT, UPDATE, INSERT для всех 
# таблиц в схеме HR_POC роли folomkin_dev
grant select, update, insert on all tables in schema hr_poc to folomkin_dev;

#Предоставление всех привилегий для всех таблиц в схеме HR POC
#роли folomkin_dev
grant all privileges on all tables in schema hr_poc to folomkin_dev;

#Предоставление всех привилегий для таблицы customers в 
#схеме hr_poc роли folomkin_dev.
GRANT ALL PRIVILEGES ON TABLE customers IN SCHEMA HR_POC TO folomkin_dev;

#Предоставление привилегий на создание и просмотр объектов в схеме
#hr_poc роли folomkin_dev.
GRANT create, usage ON SCHEMA HR_POC TO folomkin_dev;
```

Данные о предоставленных привилегиях содержатся в таблице
information_schema.role_table_grants.

### Отзыв привилегий

Для отзыва предоставленных привилегий используется команду

```shell
REVOKE {привилегии} ON {объект} FROM {роль};

#Отзыв привилегий INSERT для всех таблиц в схеме HR_POC у роли user1.
REVOKE INSERT ON ALL TABLES IN SCHEMA HR_POC FROM user1;

#Отзыв привилегий DELETE, TRUNCATE для одной таблицы у роли user1.
REVOKE DELETE, TRUNCATE ON TABLE customers FROM user1;

#Отзыв привилегий UPDATE для столбца creditlimit таблицы customers у роли user1.
REVOKE UPDATE (credit_limit) ON TABLE customers FROM user1;
```

### Пример создания новой базы данных и предоставления привилегий

```shell
create database test;
create role developer superuser createdb login password 'developer';
grant all privileges on database test to developer;
create schema hr_poc3;
create table customers
(
    customer_id integer primary key ,
    c_name varchar(255) not null ,
    address varchar(255),
    credit_limit numeric(10,2)
);
```

## СТРУКТУРА ОПЕРАТОРА SELECT И ФОРМИРОВАНИЕ УСЛОВИЙ ВЫБОРА

Операторы SQL разделены на три группы:

1. Операторы манипулирования данными (Data Manipulation Language,
   DML) — предназначены для выборки и изменения данных: SELECT,
   INSERT, UPDATE, MERGE, DELETE.
2. Операторы определения данных (Data Definition Language, DDL) —
   предназначены для создания и модификации объектов базы данных. Основными
   операторами этой группы являются: CREATE, ALTER, DROP.
3. Операторы управления данными (Data Control Language, DCL) —
   предназначены для предоставления пользователям прав на выполнение
   определенных действий с базой данных: GRANT, REVOKE.

## СТРУКТУРА ОПЕРАТОРА SELECT

    SELECT [ALL(DISTINCT] {список столбцов или выражений}
    [FROM {список таблиц}]
    [WHERE {условия выбора}]
    [GROUP BY {столбцы группировки}]
    [HAVING {условия на группу}];
    [ORDER BY {столбцы сортировки [ASC|DESC]]}
    [LIMIT {N} ] [OFFSET{М}];

(Квадратными скобками отмечены необязательные элементы).

Описание элементов:

- Оператор SELECT начинается со списка столбцов или выражений, значения
  которых будет отображаться в результате выполнения запроса. По умолчанию
  SELECT не исключает дублирование строк. Для исключения дублирования следует
  использовать ключевое слово DISTINCT.
- В предложении FROM указываются источники данных. В качестве таких
  источников можно использовать таблицы базы данных, которые возвращают
  подзапросы или представления. В тех запросах, где используется несколько
  таблиц, необходимо указывать условия соединения. Если этого не сделать, то
  будет осуществляться декартово произведение таблиц.
- Предложение WHERE содержит условия выбора строк, а также может содержать
  условия соединения таблиц в многотабличных запросах.
- В предложении GROUP BY можно указать столбцы, по которым следует осуществить
  группировку. Группировка состоит в том, что несколько строк, имеющих
  совпадающие значения столбцов, по которым осуществляется группировка,
  объединяются в одну строку. Обычно группировка используется в запросах,
  использующих агрегатные функции, например:Sum(), Мах().

## Условия выбора (WHERE)

Для того чтобы выводить только те данные, которые
удовлетворяют определенным условиям, оператор SELECT
должен содержать предложение WHERE, которое содержит
условное выражение:

    SELECT {список столбцов}
    FROM {таблица}
    WHERE {условное выражение};

Условное выражение для каждой строки таблицы может принимать значения:
ИСТИНА (TRUE), ЛОЖЬ (FALSE), НЕ ОПРЕДЕЛЕНО (UNKNOWN).
Результат выполнения запроса будет содержать только те
строки, для которых условное выражение будет иметь значение ИСТИНА (TRUE).

В условных выражениях предложения WHERE могут быть использованы
операторы сравнения =, >, < и логические операторы NOT, AND, OR. Логические
операторы используются для формирования сложных условий выбора
и имеют разный приоритет. Сначала выполняются все операторы NOT,
потом операторы AND; операторы OR выполняются в последнюю очередь.
Для исключения возможных ошибок при формировании сложных запросов
следует использовать скобки. Выражения внутри скобок выполняются первыми,
слева направо.

    SELECT employee_id, first_name, last_name, department_id, job_id
    FROM Employees
    WHERE (department_id = 50) AND (job_id= 'ST_MAN');

    SELECT * FROM Orders
    WHERE (salesman_id = 155) AND (order_date ='15.03.2018'
    OR order_date ='02.11.2019');

## Выражения выбора

Для формирования условий выбора можно использовать специальные выражения:

- `LIKE 'шаблон'`: Совпадает ли часть строкового значения с заданным шаблоном:
  [first_name LIKE '_а%'];
- `BETWEEN V_MIN AND V_MAX`:  
  Находится ли значение столбца в диапазоне от V_MIN до V_МАХ:
  [rating_e BETWEEN 2 And 4]:
- `IN(список)`: Совпадает ли значение столбца с одним из элементов списка
  значений: [rating_e IN (2;4)];
- `IS NULL`: Значение столбца не определено: [rating_e IS NULL];

### Выражение LIKE

Выражение LIKE применяется при работе со строками. Оно проверяет, совпадет ли
часть строки с заданным шаблоном. Если совпадение найдено, то оператор
возвращает значение TRUE, в противном случае возвращается FALSE.

Для создания шаблонов в выражении LIKE используются следующие
символы:

- символ подчеркивания "_" — обозначает один символ;
- символ процента "%" — обозначает любую, в том числе и пустую,
  последовательность символов.

Синтаксис:

```
{имя столбца} LIKE 'шаблон'
```

Примеры использования выражения LIKE:

- Вывод данных о сотрудниках, имена которых начинаются на букву L:

```
 SELECT employee_id, first_name, last_name, department_id
 FROM Employees
 WHERE first_name LIKE ' L% ';
```

- Вывести имена сотрудников, вторым символом которых является буква "а":

```
SELECT DISTINCT first_name
FROM Employees
WHERE first_name LIKE '_a%’;
```

Вывести имена сотрудников, которые состоят из четырех символов, начинаются на
букву J и заканчиваются буквой п:

```
SELECT DISTINCT first_name
FROM Employees
WHERE first_name LIKE 'J__n';
```

Для поиска в строке символов_ и % при построении шаблона используется
опция ESCAPE 7'. Символ, который в шаблоне будет располагаться после /,
будет рассматриваться как символ поиска. Вместо символа / можно использовать
и другие символы, например !.

Вывести имена и адреса клиентов, столбец address которых содержит символ "_":

```
SELECT c_name, address,
FROM Customers
WHERE address LIKE '%/_%' ESCAPE '/'
```

### Выражение BETWEEN